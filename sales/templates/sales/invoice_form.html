{% extends 'inventory_app/base.html' %}
{% load static %}

{% block title %}Create/Edit Invoice{% endblock %}

{% block content %}
<div class="container-fluid">
  <h1 class="h3 mb-4 text-gray-800">{% if invoice %}Edit{% else %}Create{% endif %} Invoice</h1>

  <form method="POST" id="invoiceForm">
    {% csrf_token %}
    <div class="card shadow mb-4">
      <div class="card-body">
        <!-- Invoice Details (stacked) -->
        <div class="form-group mb-3">
          <label for="client">Client</label>
          <select name="client" id="client" class="form-control" required>
            <option value="">Select Client</option>
            {% for c in clients %}
              <option value="{{ c.id }}" {% if invoice and invoice.client.id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group mb-3">
          <label for="prepared_by">Prepared By</label>
          <input type="text" class="form-control" id="prepared_by" name="prepared_by" value="{% if invoice %}{{ invoice.prepared_by }}{% endif %}" required>
        </div>

        <div class="form-group mb-3">
          <label for="order_number">Order Number</label>
          <input type="text" class="form-control" id="order_number" name="order_number" value="{% if invoice %}{{ invoice.order_number }}{% endif %}">
        </div>

        <div class="form-group mb-3">
          <label for="delivery_note_number">Delivery Note Number</label>
          <input type="text" class="form-control" id="delivery_note_number" name="delivery_note_number" value="{% if invoice %}{{ invoice.delivery_note_number }}{% endif %}">
        </div>

        <!-- Items Table -->
<h5>Invoice Items</h5>
<div class="table-responsive">
  <table class="table table-bordered" id="itemsTable">
    <thead class="thead-light">
      <tr>
        <th>Designation</th>
        <th>Description</th>
        <th>Brand</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if invoice %}
        {% for item in invoice.items.all %}
          <tr>
            <td><input type="text" name="designation" class="form-control" value="{{ item.designation }}"></td>
            <td><input type="text" name="description" class="form-control" value="{{ item.description }}" required></td>
            <td><input type="text" name="brand" class="form-control" value="{{ item.brand }}"></td>
            <td><input type="number" name="quantity" class="form-control qty" value="{{ item.quantity }}" min="1" required></td>
            <td><input type="number" name="unit_price" class="form-control unit_price" value="{{ item.unit_price }}" step="0.01" min="0" required></td>
            <td><input type="number" name="amount" class="form-control amount" value="{{ item.amount }}" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm delete-row">Delete</button></td>
          </tr>
        {% endfor %}
      {% else %}
        <!-- Default empty row for new invoice -->
        <tr>
          <td><input type="text" name="designation" class="form-control"></td>
          <td><input type="text" name="description" class="form-control" required></td>
          <td><input type="text" name="brand" class="form-control"></td>
          <td><input type="number" name="quantity" class="form-control qty" value="1" min="1" required></td>
          <td><input type="number" name="unit_price" class="form-control unit_price" value="0.00" step="0.01" min="0" required></td>
          <td><input type="number" name="amount" class="form-control amount" value="0.00" readonly></td>
          <td><button type="button" class="btn btn-danger btn-sm delete-row">Delete</button></td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>


        <!-- Add Item Button -->
        <button type="button" class="btn btn-primary mb-3" id="addItem">Add Item</button>

        <!-- Save/Cancel Buttons -->
        <div class="mt-3">
          <button type="submit" class="btn btn-success">Save Invoice</button>
          <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary">Cancel</a>
        </div>

      </div>
    </div>
  </form>
</div>

<!-- JS for dynamic rows -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function recalcAmount(row) {
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const price = parseFloat(row.querySelector('.unit_price').value) || 0;
      row.querySelector('.amount').value = (qty * price).toFixed(2);
    }

    // Add Item
    document.getElementById('addItem').addEventListener('click', function() {
      const table = document.getElementById('itemsTable').querySelector('tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" name="designation" class="form-control"></td>
        <td><input type="text" name="description" class="form-control" required></td>
        <td><input type="text" name="brand" class="form-control"></td>
        <td><input type="number" name="quantity" class="form-control qty" value="1" min="1" required></td>
        <td><input type="number" name="unit_price" class="form-control unit_price" value="0.00" step="0.01" min="0" required></td>
        <td><input type="number" name="amount" class="form-control amount" value="0.00" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm delete-row">Delete</button></td>
      `;
      table.appendChild(newRow);

      newRow.querySelector('.qty').addEventListener('input', () => recalcAmount(newRow));
      newRow.querySelector('.unit_price').addEventListener('input', () => recalcAmount(newRow));
      newRow.querySelector('.delete-row').addEventListener('click', () => newRow.remove());
    });

    // Existing rows
    document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
      row.querySelector('.qty').addEventListener('input', () => recalcAmount(row));
      row.querySelector('.unit_price').addEventListener('input', () => recalcAmount(row));
      row.querySelector('.delete-row').addEventListener('click', () => row.remove());
      recalcAmount(row); // initial calculation
    });
  });
</script>
{% endblock %}
