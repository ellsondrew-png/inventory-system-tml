{% extends "inventory_app/base.html" %}
{% block title %}Add Quotation{% endblock %}

{% block content %}
<h2>{% if quotation %}Edit Quotation{% else %}Add Quotation{% endif %}</h2>

<form method="post" novalidate>
    {% csrf_token %}

    <!-- Client Selection -->
    <div class="mb-3">
        <label for="client">Client:</label>
        <select name="client" id="client" class="form-control" required>
            <option value="">Select Client</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if quotation and quotation.client.id == client.id %}selected{% endif %}>
                {{ client.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Prepared By -->
    <div class="mb-3">
        <label for="prepared_by">Prepared By:</label>
        <input type="text" name="prepared_by" id="prepared_by" class="form-control"
               value="{% if quotation %}{{ quotation.prepared_by }}{% endif %}" required>
    </div>

    <!-- Validity Period -->
    <div class="mb-3">
        <label for="validity_period">Validity Period (days):</label>
        <input type="number" name="validity_period" id="validity_period" class="form-control"
               value="{% if quotation %}{{ quotation.validity_period }}{% else %}14{% endif %}" required>
    </div>

    <!-- Quotation Items -->
    <h4>Items</h4>
    <table class="table table-bordered" id="items_table">
        <thead>
            <tr>
                <th>Designation</th>
                <th>Description</th>
                <th>Brand</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% if quotation %}
                {% for item in quotation.items.all %}
                <tr>
                    <td><input type="text" name="designation" class="form-control" value="{{ item.designation }}"></td>
                    <td><input type="text" name="description" class="form-control" value="{{ item.description }}"></td>
                    <td><input type="text" name="brand" class="form-control" value="{{ item.brand }}"></td>
                    <td><input type="number" name="quantity" class="form-control" value="{{ item.quantity }}"></td>
                    <td><input type="number" step="0.01" name="unit_price" class="form-control" value="{{ item.unit_price }}"></td>
                    <td><input type="number" name="amount" class="form-control" value="{{ item.amount }}" step="0.01" readonly></td>
                    <td><button type="button" class="btn btn-danger remove-item">Remove</button></td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td><input type="text" name="designation" class="form-control"></td>
                <td><input type="text" name="description" class="form-control"></td>
                <td><input type="text" name="brand" class="form-control"></td>
                <td><input type="number" name="quantity" class="form-control"></td>
                <td><input type="number" step="0.01" name="unit_price" class="form-control"></td>
                <td><input type="number" name="amount" class="form-control" step="0.01" readonly></td>
                <td><button type="button" class="btn btn-danger remove-item">Remove</button></td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    <button type="button" class="btn btn-primary" id="add_item">Add Item</button>

    <hr>
    <button type="submit" class="btn btn-success">Save</button>
    <a href="{% url 'sales:quotation_list' %}" class="btn btn-secondary">Cancel</a>
</form>

<!-- JavaScript to add/remove items and calculate amount -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('add_item');
    const tableBody = document.querySelector('#items_table tbody');

    function updateAmount(row) {
        const qty = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="unit_price"]').value) || 0;
        row.querySelector('input[name="amount"]').value = (qty * price).toFixed(2);
    }

    function attachEvents(row) {
        row.querySelectorAll('input[name="quantity"], input[name="unit_price"]').forEach(input => {
            input.addEventListener('input', () => updateAmount(row));
        });
        row.querySelector('.remove-item').addEventListener('click', () => row.remove());
    }

    // Attach events to existing rows
    tableBody.querySelectorAll('tr').forEach(row => attachEvents(row));

    // Add new row
    addBtn.addEventListener('click', function() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" name="designation" class="form-control"></td>
            <td><input type="text" name="description" class="form-control"></td>
            <td><input type="text" name="brand" class="form-control"></td>
            <td><input type="number" name="quantity" class="form-control"></td>
            <td><input type="number" step="0.01" name="unit_price" class="form-control"></td>
            <td><input type="number" name="amount" class="form-control" step="0.01" readonly></td>
            <td><button type="button" class="btn btn-danger remove-item">Remove</button></td>
        `;
        tableBody.appendChild(row);
        attachEvents(row);
    });
});
</script>
{% endblock %}
